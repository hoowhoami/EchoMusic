<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="X-UA-Compatible"
      content="IE=edge"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>EchoMusic - 桌面歌词</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        user-select: none;
        box-sizing: border-box;
        -webkit-user-drag: none;
      }

      :root {
        --font-size: 24;
        --main-color: #fff;
        --lyrics-text-color: #333333;
        --lyrics-shadow-color: rgba(0, 0, 0, 0.8);
        --control-color: #fff;
        --shadow-color: rgba(0, 0, 0, 0.8);
        --highlight-color: #EF0CDCFF;
      }

      body {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        height: 100%;
        padding: 12px;
        cursor: pointer;
        color: var(--control-color);
        overflow: hidden;
        transition: opacity 0.3s;

        &::after {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          border-radius: 16px;
          background-color: rgba(0, 0, 0, 0.8);
          backdrop-filter: blur(10px);
          z-index: 0;
          opacity: 0;
          cursor: move;
          transition: opacity 0.3s;
        }

        &:hover {
          &::after {
            opacity: 1;
          }

          header {
            .meta {
              opacity: 0;
            }

            .tools {
              opacity: 1;
            }
          }

          main {
            #lyric-text {
              color: #ffffff !important;
            }

            #lyric-tran {
              color: #ffffff !important;
            }
          }
        }

        &.lock-lyric {
          cursor: none;

          &::after {
            opacity: 0 !important;
          }

          &:hover {
            &::after {
              opacity: 0 !important;
            }
          }

          header {
            .meta {
              opacity: 1;
            }

            .tools {
              opacity: 0;
              pointer-events: none;

              #lock-lyric {
                opacity: 1;
                pointer-events: auto;
                background-color: rgba(255, 0, 0, 0.3);
                border: 1px solid rgba(255, 0, 0, 0.5);
              }
            }

            &:hover .tools {
              opacity: 1;
              pointer-events: auto;

              .item:not(#lock-lyric) {
                opacity: 0.2;
                pointer-events: none;
              }

              #lock-lyric {
                opacity: 1;
                pointer-events: auto;
                background-color: rgba(255, 0, 0, 0.5);
              }
            }
          }

          main {
            pointer-events: none;
          }
        }
      }

      header {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 1;

        .meta {
          display: flex;
          flex-direction: column;
          align-items: center;
          font-size: 14px;
          opacity: 0.9;
          transition: opacity 0.3s;
          color: var(--lyrics-text-color);
        }

        .tools {
          display: flex;
          align-items: center;
          justify-content: center;
          position: absolute;
          opacity: 0;
          transition: opacity 0.3s;
          gap: 8px;

          .item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            border-radius: 8px;
            cursor: pointer;
            transition:
              transform 0.3s,
              background-color 0.3s;

            &.hidden {
              display: none;
            }

            &:hover {
              background-color: rgba(0, 0, 0, 0.4);
            }

            &:active {
              transform: scale(0.95);
            }

            svg {
              width: 24px;
              height: 24px;
            }
          }
        }

        #song-artist {
          margin-top: 4px;
          font-size: 12px;
          opacity: 0.9;
          color: var(--highlight-color);
          font-weight: bold;
          text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        #song-name {
          color: var(--highlight-color);
          font-weight: bold;
          text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
      }

      main {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0 12px;
        margin: 12px;
        z-index: 1;
        max-width: 100%;
        pointer-events: auto;
        /* 预留两行歌词的固定高度，防止换行时跳动 */
        min-height: calc(var(--font-size) * 1px * 2 + var(--font-size) * 1px * 0.4 + 20px); /* 主歌词2行 + 行距 + 翻译间距 */
        box-sizing: border-box;

        #lyric-text {
          font-size: calc(var(--font-size) * 1px);
          font-weight: bold;
          color: var(--lyrics-text-color);
          max-width: 100%;
          padding: 0 4px;
          transition: opacity 0.3s;
          text-align: center;
          line-height: 1.2;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;

          /* 内部的span（实际歌词） */
          span {
            display: inline;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
          }
        }

        #lyric-tran {
          font-size: calc(var(--font-size) * 1px - 5px);
          margin-top: 8px;
          opacity: 0.6;
          color: var(--lyrics-text-color);
          max-width: 100%;
          padding: 0 4px;
          text-align: center;
          line-height: 1.3;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
      }

      /* 确保歌曲信息使用高亮颜色 */
      .meta span {
        color: var(--highlight-color) !important;
        font-weight: bold !important;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
      }

      @keyframes wordsLoop {
        0% {
          transform: translateX(0px);
        }

        100% {
          transform: translateX(-100%);
        }
      }
    </style>
  </head>

  <body>
    <header>
      <div class="meta">
        <span id="song-name">EchoMusic</span>
        <span id="song-artist">未知艺术家</span>
      </div>
      <div
        class="tools"
        id="tools"
      >
        <div
          id="show-app"
          class="item"
          style="margin-top: 2px"
          title="打开应用"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z"
            />
          </svg>
        </div>
        <div
          id="font-size-reduce"
          class="item"
          title="缩小字体"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M10.5 7h-2L3 21h2.2l1.1-3h6.2l1.1 3H16zm-3.4 9l2.4-6.3l2.4 6.3zM22 7h-8V5h8z"
            />
          </svg>
        </div>
        <div
          id="font-size-add"
          class="item"
          title="放大字体"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M8.5 7h2L16 21h-2.4l-1.1-3H6.3l-1.1 3H3zm-1.4 9h4.8L9.5 9.7zM22 5v2h-3v3h-2V7h-3V5h3V2h2v3z"
            />
          </svg>
        </div>
        <div
          id="play-prev"
          class="item"
          title="上一首"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M7 6c.55 0 1 .45 1 1v10c0 .55-.45 1-1 1s-1-.45-1-1V7c0-.55.45-1 1-1m3.66 6.82l5.77 4.07c.66.47 1.58-.01 1.58-.82V7.93c0-.81-.91-1.28-1.58-.82l-5.77 4.07a1 1 0 0 0 0 1.64"
            />
          </svg>
        </div>
        <div
          id="pause"
          class="item hidden"
          title="暂停"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M8 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2m6-12v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2"
            />
          </svg>
        </div>
        <div
          id="play"
          class="item"
          title="播放"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18a1 1 0 0 0 0-1.69L9.54 5.98A.998.998 0 0 0 8 6.82"
            />
          </svg>
        </div>
        <div
          id="play-next"
          class="item"
          title="下一首"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="m7.58 16.89l5.77-4.07c.56-.4.56-1.24 0-1.63L7.58 7.11C6.91 6.65 6 7.12 6 7.93v8.14c0 .81.91 1.28 1.58.82M16 7v10c0 .55.45 1 1 1s1-.45 1-1V7c0-.55-.45-1-1-1s-1 .45-1 1"
            />
          </svg>
        </div>
        <div
          id="toggle-translation"
          class="item"
          title="切换翻译/音译"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"
            />
          </svg>
        </div>
        <div
          id="lock-lyric"
          class="item"
          title="锁定/解锁"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2M9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9zm9 14H6V10h12zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2s-2 .9-2 2s.9 2 2 2"
            />
          </svg>
        </div>
        <div
          id="close-lyric"
          class="item"
          title="关闭"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M13.46 12L19 17.54V19h-1.46L12 13.46L6.46 19H5v-1.46L10.54 12L5 6.46V5h1.46L12 10.54L17.54 5H19v1.46z"
            />
          </svg>
        </div>
      </div>
    </header>
    <main id="lyric-content">
      <span id="lyric-text">该歌曲暂无歌词</span>
      <span id="lyric-tran"></span>
    </main>
    <script>
      class LyricsWindow {
        constructor() {
          if (typeof window.require !== 'undefined') {
            try {
              const { ipcRenderer } = window.require('electron');
              window.electron = { ipcRenderer };
            } catch (error) {
              console.error('[Desktop Lyrics] Failed to get ipcRenderer from require:', error);
            }
          }

          this.songNameDom = document.getElementById('song-name');
          this.songArtistDom = document.getElementById('song-artist');
          this.lyricContentDom = document.getElementById('lyric-content');
          this.lyricTextDom = document.getElementById('lyric-text');
          this.lyricTranDom = document.getElementById('lyric-tran');
          this.pauseDom = document.getElementById('pause');
          this.playDom = document.getElementById('play');

          this.isDragging = false;
          this.startX = 0;
          this.startY = 0;
          this.startWinX = 0;
          this.startWinY = 0;
          this.winWidth = 0;
          this.winHeight = 0;

          this.resizeTimeout = null;
          this.contentChangeTimeout = null;

          // 添加防抖机制来减少DOM更新频率
          this.lastContentUpdate = '';
          this.updateDebounceTimeout = null;

          this.initializeAsync().catch(error => {
            console.error('[Desktop Lyrics] Initialization failed:', error);
          });

          this.setupBasicDrag();
        }

        setupBasicDrag() {
          const lyricContent = document.getElementById('lyric-content');

          if (lyricContent) {
            lyricContent.addEventListener('mousedown', async (event) => {
              event.preventDefault();

              let isDragging = false;
              const startX = event.screenX;
              const startY = event.screenY;
              let initialWindowX = 0;
              let initialWindowY = 0;

              // 获取窗口初始位置
              if (window.electron?.ipcRenderer) {
                try {
                  const bounds = await window.electron.ipcRenderer.invoke('get-window-bounds');
                  initialWindowX = bounds.x;
                  initialWindowY = bounds.y;
                  isDragging = true;
                } catch (error) {
                  console.error('[Desktop Lyrics] Failed to get initial window bounds:', error);
                  return;
                }
              }

              const handleMouseMove = (moveEvent) => {
                if (!isDragging) return;

                const deltaX = moveEvent.screenX - startX;
                const deltaY = moveEvent.screenY - startY;
                const newX = initialWindowX + deltaX;
                const newY = initialWindowY + deltaY;

                if (window.electron?.ipcRenderer) {
                  window.electron.ipcRenderer.send('set-window-position-direct', { x: newX, y: newY });
                }
              };

              const handleMouseUp = () => {
                isDragging = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };

              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            });
          } else {
            console.error('[Desktop Lyrics] lyric-content element not found for basic drag');
          }
        }

        async initializeAsync() {
          try {
            await this.loadSettings();
            await this.applyInitialColors();
            await this.applySongInfoColors();
            // 注释掉 restoreOptions，因为 loadSettings 已经从Pinia获取了正确的设置
            // await this.restoreOptions();

            this.menuClick();
            this.setupIPCListeners();
            this.setupWindowDragListeners();
            this.setupWindowResizeListeners();
            this.setupMutationObserver();

            // 通知主进程窗口已准备好
            if (window.electron?.ipcRenderer) {
              window.electron.ipcRenderer.send('lyrics-window-ready');

              // 恢复窗口位置
              await this.restoreWindowPosition();

              // 位置恢复完成后显示窗口
              window.electron.ipcRenderer.send('lyrics-window-position-restored');
            } else {
              console.error('[Desktop Lyrics] window.electron.ipcRenderer not available!');
              // 如果没有ipcRenderer，延迟一点时间后直接显示窗口
              setTimeout(() => {
                if (window.electron?.ipcRenderer) {
                  window.electron.ipcRenderer.send('lyrics-window-position-restored');
                }
              }, 1000);
            }
          } catch (error) {
            console.error('[Desktop Lyrics] Error during initialization:', error);
            // 出错时也要显示窗口，避免窗口一直隐藏
            if (window.electron?.ipcRenderer) {
              window.electron.ipcRenderer.send('lyrics-window-position-restored');
            }
          }
        }

        async loadSettings() {
          const settings = await this.getStoredSettings();

          if (settings.fontSize) {
            document.documentElement.style.setProperty('--font-size', settings.fontSize);
          }
          if (settings.lyricsTextColor) {
            document.documentElement.style.setProperty(
              '--lyrics-text-color',
              settings.lyricsTextColor,
            );
          }
          if (settings.highlightColor) {
            document.documentElement.style.setProperty(
              '--highlight-color',
              settings.highlightColor,
            );
          }
          if (settings.locked !== undefined) {
            this.setLockState(settings.locked);
          }

          // 应用窗口大小设置
          if (settings.windowWidth || settings.windowHeight) {
            if (window.electron?.ipcRenderer) {
              try {
                const currentBounds = await window.electron.ipcRenderer.invoke('get-window-bounds');
                const newSize = {
                  width: settings.windowWidth || currentBounds.width,
                  height: settings.windowHeight || currentBounds.height
                };
                console.log('[Desktop Lyrics] Applying window size from settings:', newSize);
                await window.electron.ipcRenderer.invoke('set-window-size', newSize);
              } catch (error) {
                console.error('[Desktop Lyrics] Failed to apply window size:', error);
              }
            }
          }
        }

        async applyInitialColors() {
          // 强制应用初始颜色设置
          const settings = await this.getStoredSettings();

          // 应用到CSS变量
          document.documentElement.style.setProperty(
            '--lyrics-text-color',
            settings.lyricsTextColor,
          );
          document.documentElement.style.setProperty('--highlight-color', settings.highlightColor);
        }

        async getStoredSettings() {
          try {
            // 从主进程获取Pinia存储的设置
            if (window.electron?.ipcRenderer) {
              try {
                // 添加超时机制
                const piniaSettings = await Promise.race([
                  window.electron.ipcRenderer.invoke('get-pinia-desktop-lyrics-settings'),
                  new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Timeout getting Pinia settings')), 3000)
                  )
                ]);

                if (piniaSettings) {
                  const isDarkTheme = this.isDarkTheme();

                  // 根据主题选择颜色
                  const currentThemeColors = isDarkTheme ? piniaSettings.darkTheme : piniaSettings.lightTheme;

                  // 获取窗口特定状态
                  const windowState = this.getWindowState();

                  const settings = {
                    fontSize: piniaSettings.fontSize,
                    windowWidth: piniaSettings.windowWidth,
                    windowHeight: piniaSettings.windowHeight,
                    lyricsTextColor: currentThemeColors.lyricsTextColor,
                    highlightColor: currentThemeColors.lyricsHighlightColor,
                    songInfoColor: currentThemeColors.songInfoColor,
                    locked: windowState.locked || false,
                    windowPosition: windowState.windowPosition || null,
                    windowSize: windowState.windowSize || null,
                  };
                  return settings;
                }
              } catch (error) {
                console.warn('[Desktop Lyrics] Failed to get Pinia settings (will use defaults):', error);
              }
            }

            // 检测当前主题
            const isDarkTheme = this.isDarkTheme();

            // 使用默认设置 - 这些应该与Pinia中的默认值保持一致
            const defaultSettings = {
              fontSize: 24,
              windowWidth: 400,
              windowHeight: 150, // 增加高度以容纳两行歌词
              lightTheme: {
                lyricsTextColor: '#333333',
                lyricsHighlightColor: '#EF0CDCFF',
                songInfoColor: '#249C09FF'
              },
              darkTheme: {
                lyricsTextColor: '#ffffff',
                lyricsHighlightColor: '#EF0CDCFF',
                songInfoColor: '#249C09FF'
              }
            };

            // 根据主题选择颜色
            const currentThemeColors = isDarkTheme ?
              {
                lyricsTextColor: defaultSettings.darkTheme.lyricsTextColor,
                lyricsHighlightColor: defaultSettings.darkTheme.lyricsHighlightColor,
                songInfoColor: defaultSettings.darkTheme.songInfoColor
              } :
              {
                lyricsTextColor: defaultSettings.lightTheme.lyricsTextColor,
                lyricsHighlightColor: defaultSettings.lightTheme.lyricsHighlightColor,
                songInfoColor: defaultSettings.lightTheme.songInfoColor
              };

            // 获取窗口特定状态
            const windowState = this.getWindowState();

            return {
              fontSize: defaultSettings.fontSize,
              windowWidth: defaultSettings.windowWidth,
              windowHeight: defaultSettings.windowHeight,
              lyricsTextColor: currentThemeColors.lyricsTextColor,
              highlightColor: currentThemeColors.lyricsHighlightColor,
              songInfoColor: currentThemeColors.songInfoColor,
              locked: windowState.locked || false,
              windowPosition: windowState.windowPosition || null,
              windowSize: windowState.windowSize || null,
            };
          } catch (error) {
            console.warn('[Desktop Lyrics] Failed to get settings:', error);
          }

          // 默认设置 - 自适应颜色
          const isDarkTheme = this.isDarkTheme();
          const windowState = this.getWindowState();

          return {
            fontSize: 24,
            windowWidth: 400,
            windowHeight: 150, // 增加高度以容纳两行歌词
            lyricsTextColor: isDarkTheme ? '#ffffff' : '#333333',
            highlightColor: isDarkTheme ? '#EF0CDCFF' : '#EF0CDCFF',
            songInfoColor: isDarkTheme ? '#249C09FF' : '#249C09FF',
            locked: windowState.locked || false,
            windowPosition: windowState.windowPosition || null,
            windowSize: windowState.windowSize || null,
          };
        }

        getWindowState() {
          try {
            const windowStateStr = localStorage.getItem('lyrics-window-state');
            if (windowStateStr) {
              return JSON.parse(windowStateStr);
            }
          } catch (error) {
            console.warn('[Desktop Lyrics] Failed to parse window state:', error);
          }
          return {};
        }

        isDarkTheme() {
          return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        }


        saveSettings(settings) {
          // 桌面歌词窗口不再直接保存设置到localStorage
          // 设置应该通过主应用的Pinia store管理
          // 这里只保留一些窗口特定的设置，如锁定状态、窗口位置等
          try {
            if (settings.locked !== undefined || settings.windowPosition || settings.windowSize) {
              // 只保存窗口特定的状态到localStorage
              const windowState = {
                locked: settings.locked,
                windowPosition: settings.windowPosition,
                windowSize: settings.windowSize
              };
              localStorage.setItem('lyrics-window-state', JSON.stringify(windowState));
            }
          } catch (error) {
            console.error('[Desktop Lyrics] Failed to save window state:', error);
          }
        }

        async restoreWindowPosition() {
          try {
            const settings = await this.getStoredSettings();

            if (window.electron?.ipcRenderer) {
              // 恢复窗口位置
              if (settings.windowPosition) {
                await window.electron.ipcRenderer.invoke(
                  'set-window-position',
                  settings.windowPosition,
                );
              }

              // 恢复窗口大小
              if (settings.windowSize) {
                await window.electron.ipcRenderer.invoke('set-window-size', settings.windowSize);
              }
            }
          } catch (error) {
            console.warn('[Desktop Lyrics] Failed to restore window position/size:', error);
          }
        }

        setLockState(locked) {
          document.body.classList.toggle('lock-lyric', locked);
          this.saveSettings({ locked });
        }

        updateLyrics(content = '纯音乐，请欣赏', translation = '') {
          if (this.lyricTextDom && this.lyricTranDom) {
            this.lyricTextDom.innerHTML = `<span>${content}</span>`;
            this.lyricTranDom.innerHTML = translation;
          }
        }

        async updateLyricsWithHighlight(line, currentTime, lyricsMode = 'translation') {
          if (!line || !line.characters || !line.characters.length) {
            this.updateLyrics('该歌曲暂无歌词');
            return;
          }

          const lineText = this.formatLyricsLineText(line);
          const settings = await this.getStoredSettings();

          // 创建高亮HTML
          let highlightedHtml = '';
          const characters = line.characters;

          for (let i = 0; i < characters.length; i++) {
            const char = characters[i];
            const isHighlighted = currentTime >= char.startTime && currentTime <= char.endTime;

            if (isHighlighted) {
              highlightedHtml += `<span style="color: ${settings.highlightColor}; font-weight: bold;">${char.char}</span>`;
            } else if (currentTime > char.endTime) {
              highlightedHtml += `<span style="color: ${settings.highlightColor}; font-weight: bold;">${char.char}</span>`;
            } else {
              highlightedHtml += `<span style="color: ${settings.lyricsTextColor};">${char.char}</span>`;
            }
          }

          if (this.lyricTextDom) {
            this.lyricTextDom.innerHTML = highlightedHtml;
          }

          // 根据 lyricsMode 决定显示翻译还是音译
          if (this.lyricTranDom) {
            let translationText = '';
            if (lyricsMode === 'translation' && line.translated) {
              translationText = line.translated;
            } else if (lyricsMode === 'romanization' && line.romanized) {
              translationText = line.romanized;
            }
            this.lyricTranDom.innerHTML = translationText;
          }
        }

        formatLyricsLineText(line) {
          if (!line || !line.characters || !line.characters.length) return '';
          return line.characters.map(char => char.char).join('');
        }

        async restoreOptions() {
          try {
            // 先检查是否有本地保存的设置
            const localSettings = localStorage.getItem('lyrics-setting');
            if (localSettings) {
              return JSON.parse(localSettings);
            }

            // 如果没有本地设置，则从主进程获取默认设置（添加超时）
            if (window.electron?.ipcRenderer) {
              try {
                const defaultOptions = await Promise.race([
                  window.electron.ipcRenderer.invoke('get-desktop-lyric-option'),
                  new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Timeout getting default options')), 2000)
                  )
                ]);

                if (defaultOptions) {
                  this.changeOptions(defaultOptions);
                  return defaultOptions;
                }
              } catch (error) {
                console.warn('[Desktop Lyrics] Failed to get default options (will skip):', error);
              }
            }

            return null;
          } catch (error) {
            console.error('Failed to restore options:', error);
            return null;
          }
        }

        changeOptions(options, callback = true) {
          if (!options) return;
          const { fontSize, mainColor, shadowColor, lyricsTextColor, lyricsShadowColor, windowWidth, windowHeight } = options;

          if (fontSize) {
            document.documentElement.style.setProperty('--font-size', fontSize);
          }
          if (mainColor) {
            document.documentElement.style.setProperty('--main-color', mainColor);
          }
          if (shadowColor) {
            document.documentElement.style.setProperty('--shadow-color', shadowColor);
          }
          if (lyricsTextColor) {
            document.documentElement.style.setProperty('--lyrics-text-color', lyricsTextColor);
          }
          if (lyricsShadowColor) {
            document.documentElement.style.setProperty('--lyrics-shadow-color', lyricsShadowColor);
          }

          // 处理窗口大小变化
          if (windowWidth || windowHeight) {
            if (window.electron?.ipcRenderer) {
              // 获取当前窗口大小作为基础
              window.electron.ipcRenderer.invoke('get-window-bounds').then(currentBounds => {
                const newSize = {
                  width: windowWidth || currentBounds.width,
                  height: windowHeight || currentBounds.height
                };

                // 更新窗口大小
                window.electron.ipcRenderer.invoke('set-window-size', newSize).then(() => {
                  // Window size updated successfully
                }).catch(error => {
                  console.error('[Desktop Lyrics] Failed to update window size:', error);
                });
              }).catch(error => {
                console.error('[Desktop Lyrics] Failed to get current bounds:', error);
              });
            }
          }

          if (callback && window.electron?.ipcRenderer) {
            window.electron.ipcRenderer.send('set-desktop-lyric-option', options);
          }
        }

        menuClick() {
          const toolsDom = document.getElementById('tools');
          if (!toolsDom) {
            console.error('[Desktop Lyrics] Tools element not found');
            return;
          }

          toolsDom.addEventListener('click', async event => {
            const target = event.target.closest('div');
            if (!target) {
              return;
            }

            const id = target.id;
            if (!id) return;

            try {
              switch (id) {
                case 'show-app': {
                  window.electron?.ipcRenderer?.send('win-show');
                  break;
                }
              case 'font-size-add': {
                const currentSettings = await this.getStoredSettings();
                let fontSize = parseInt(currentSettings.fontSize) || 24;
                if (fontSize < 30) {
                  fontSize++;
                  // 更新CSS变量
                  document.documentElement.style.setProperty('--font-size', fontSize);
                  // 通知主进程更新Pinia设置
                  if (window.electron?.ipcRenderer) {
                    window.electron.ipcRenderer.send('update-pinia-desktop-lyrics-setting', {
                      key: 'fontSize',
                      value: fontSize
                    });
                  }
                }
                break;
              }
              case 'font-size-reduce': {
                const currentSettings = await this.getStoredSettings();
                let fontSize = parseInt(currentSettings.fontSize) || 24;
                if (fontSize > 24) {
                  fontSize--;
                  // 更新CSS变量
                  document.documentElement.style.setProperty('--font-size', fontSize);
                  // 通知主进程更新Pinia设置
                  if (window.electron?.ipcRenderer) {
                    window.electron.ipcRenderer.send('update-pinia-desktop-lyrics-setting', {
                      key: 'fontSize',
                      value: fontSize
                    });
                  }
                }
                break;
              }
              case 'play': {
                window.electron?.ipcRenderer?.send('send-main-event', 'play');
                break;
              }
              case 'pause': {
                window.electron?.ipcRenderer?.send('send-main-event', 'pause');
                break;
              }
              case 'play-prev': {
                window.electron?.ipcRenderer?.send('send-main-event', 'playPrev');
                break;
              }
              case 'play-next': {
                window.electron?.ipcRenderer?.send('send-main-event', 'playNext');
                break;
              }
              case 'toggle-translation': {
                window.electron?.ipcRenderer?.send('send-main-event', 'toggleLyricsMode');
                break;
              }
              case 'close-lyric': {
                window.electron?.ipcRenderer?.send('closeDesktopLyric');
                break;
              }
              case 'lock-lyric': {
                const isLocked = !document.body.classList.contains('lock-lyric');
                this.setLockState(isLocked);
                window.electron?.ipcRenderer?.send('toggleDesktopLyricLock', isLocked);
                break;
              }
              default:
                break;
            }
            } catch (error) {
              console.error('[Desktop Lyrics] Error handling button click:', error);
            }
          });
        }

        async applySongInfoColors() {
          const settings = await this.getStoredSettings();
          const songInfoColor = settings.songInfoColor;

          if (this.songNameDom) {
            this.songNameDom.style.color = songInfoColor;
          }
          if (this.songArtistDom) {
            this.songArtistDom.style.color = songInfoColor;
          }
        }

        hexToColor(color) {
          // 确保返回有效的hex颜色值
          if (color && color.startsWith('#') && color.length === 7) {
            return color;
          }
          // 如果不是有效的hex颜色，返回默认值
          return '#ffffff';
        }

        setupIPCListeners() {
          // Function to setup listeners when ipcRenderer becomes available
          const setupListeners = () => {
            if (!window.electron?.ipcRenderer) {
              console.error('[Desktop Lyrics] window.electron.ipcRenderer still not available!');
              return false;
            }

            window.electron.ipcRenderer.on('play-song-change', async (_, title) => {
              if (!title) return;
              const [songName, songArtist] = title.split(' - ');
              this.songNameDom.innerHTML = songName || title;
              this.songArtistDom.innerHTML = songArtist || '未知艺术家';

              // 强制应用颜色
              await this.applySongInfoColors();
            });

            // 监听歌词数据更新
            window.electron.ipcRenderer.on('lyrics-data-update', (_, lyricData) => {
              if (!lyricData) {
                return;
              }
              this.parsedLyricsData(lyricData);
            });

            window.electron.ipcRenderer.on('play-status-change', (_, status) => {
              this.playDom.classList.toggle('hidden', status);
              this.pauseDom.classList.toggle('hidden', !status);
            });

            window.electron.ipcRenderer.on('desktop-lyric-option-change', (_, options) => {
              this.changeOptions(options, false);
            });

            window.electron.ipcRenderer.on('toggleDesktopLyricLock', (_, lock) => {
              this.setLockState(lock);
            });

            return true;
          };

          // Try to setup listeners immediately
          if (!setupListeners()) {
            // If not available, retry after a short delay
            setTimeout(() => {
              if (!setupListeners()) {
                setTimeout(() => {
                  setupListeners();
                }, 1000);
              }
            }, 500);
          }
        }

        async parsedLyricsData(lyricData) {
          if (!this.lyricContentDom || !this.lyricTextDom) {
            return;
          }

          if (!lyricData) {
            this.updateLyrics('该歌曲暂无歌词');
            return;
          }

          const { lyrics, currentTime, songTips, lyricsMode } = lyricData;

          if (!lyrics || lyrics.length === 0) {
            this.updateLyrics(songTips || '该歌曲暂无歌词');
            return;
          }

          const currentLineIndex = this.getCurrentLineIndex(lyrics, currentTime);

          if (currentLineIndex >= 0 && lyrics[currentLineIndex]) {
            const currentLine = lyrics[currentLineIndex];
            await this.updateLyricsWithHighlight(currentLine, currentTime, lyricsMode);
          } else if (lyrics.length > 0) {
            // 如果没有找到当前行，但有歌词，显示第一行
            const firstLine = lyrics[0];
            await this.updateLyricsWithHighlight(firstLine, currentTime, lyricsMode);
          } else {
            this.updateLyrics('该歌曲暂无歌词');
          }
        }

        getCurrentLineIndex(lyrics, currentTime) {
          if (!lyrics || lyrics.length === 0 || currentTime === undefined) return -1;

          // 确保时间是毫秒格式
          const currentTimeMs = currentTime;

          // 先尝试找到时间范围内的行
          for (let i = 0; i < lyrics.length; i++) {
            const line = lyrics[i];
            if (!line?.characters?.length) continue;

            const lineStartTime = line.characters[0].startTime;
            const lineEndTime = line.characters[line.characters.length - 1].endTime;

            if (currentTimeMs >= lineStartTime && currentTimeMs <= lineEndTime) {
              return i;
            }
          }

          // 如果没有找到精确匹配，找最接近的行
          let closestLineIndex = -1;
          let minDistance = Infinity;

          for (let i = 0; i < lyrics.length; i++) {
            const line = lyrics[i];
            if (!line?.characters?.length) continue;

            const lineStartTime = line.characters[0].startTime;
            const distance = Math.abs(currentTimeMs - lineStartTime);

            if (distance < minDistance) {
              minDistance = distance;
              closestLineIndex = i;
            }
          }

          return closestLineIndex;
        }

        formatLyricsLineText(line) {
          if (!line || !line.characters || !line.characters.length) return '';
          return line.characters.map(char => char.char).join('');
        }

        setupWindowDragListeners() {
          let isDragging = false;
          let startX = 0;
          let startY = 0;
          let startWinX = 0;
          let startWinY = 0;
          let winWidth = 0;
          let winHeight = 0;

          // 只在特定区域绑定拖拽开始事件
          const lyricContent = document.getElementById('lyric-content');
          const meta = document.querySelector('.meta');

          const handleMouseDown = async event => {
            if (document.body.classList.contains('lock-lyric')) {
              return;
            }

            // 严格检查是否点击在工具栏、按钮上
            const target = event.target;
            if (
              target.closest('.tools') ||
              target.closest('.item') ||
              target.closest('input')
            ) {
              return;
            }

            isDragging = true;
            startX = event.screenX;
            startY = event.screenY;

            if (window.electron?.ipcRenderer) {
              try {
                const bounds = await window.electron.ipcRenderer.invoke('get-window-bounds');
                startWinX = bounds.x;
                startWinY = bounds.y;
                winWidth = bounds.width;
                winHeight = bounds.height;
              } catch (error) {
                console.error('[Desktop Lyrics] Failed to get window bounds:', error);
              }
            }
          };

          const handleMouseMove = async event => {
            if (!isDragging || document.body.classList.contains('lock-lyric')) return;

            const newWinX = startWinX + (event.screenX - startX);
            const newWinY = startWinY + (event.screenY - startY);

            if (window.electron?.ipcRenderer) {
              try {
                const { width: screenWidth, height: screenHeight } =
                  await window.electron.ipcRenderer.invoke('get-screen-size');

                // 添加边界限制，确保窗口不会完全超出屏幕边界
                // 允许窗口拖动到dock以下，只要窗口顶部还在屏幕内
                const headerHeight = 40; // 预留窗口顶部标题栏区域可见
                const constrainedX = Math.max(-winWidth + 100, Math.min(screenWidth - 100, newWinX)); // 左右保留100px可见区域
                const constrainedY = Math.max(
                  -winHeight + headerHeight, // 允许窗口向下拖动，只要顶部40px还可见
                  Math.min(screenHeight - headerHeight, newWinY), // 允许拖动到屏幕底部以下
                );

                window.electron.ipcRenderer.send(
                  'move-window',
                  constrainedX,
                  constrainedY,
                  winWidth,
                  winHeight,
                );
              } catch (error) {
                console.error('[Desktop Lyrics] Failed to move window:', error);
              }
            }
          };

          const handleMouseUp = async () => {
            if (isDragging) {
              isDragging = false;
              // 保存窗口位置
              if (window.electron?.ipcRenderer) {
                try {
                  const bounds = await window.electron.ipcRenderer.invoke('get-window-bounds');

                  // 直接保存窗口位置到localStorage，不需要获取完整设置
                  const windowPosition = {
                    x: bounds.x,
                    y: bounds.y,
                  };
                  this.saveSettings({ windowPosition });

                  // 同时通知主进程更新窗口状态
                  window.electron.ipcRenderer.send('update-lyrics-window-state', {
                    x: bounds.x,
                    y: bounds.y,
                    width: bounds.width,
                    height: bounds.height
                  });
                } catch (error) {
                  console.warn('[Desktop Lyrics] Failed to save window position:', error);
                }
              }
            }
          };

          if (lyricContent) {
            lyricContent.addEventListener('mousedown', handleMouseDown);
          } else {
            console.warn('[Desktop Lyrics] lyricContent element not found for drag');
          }
          if (meta) {
            meta.addEventListener('mousedown', handleMouseDown);
          } else {
            console.warn('[Desktop Lyrics] meta element not found for drag');
          }

          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        }

        updateWindowHeight() {
          // 使用固定高度，不再动态调整
          // const bodyHeight = document.body.scrollHeight;
          // window.electron?.ipcRenderer?.send('update-window-height', bodyHeight);
        }

        // 保存当前窗口大小到本地存储
        async saveCurrentWindowSize() {
          try {
            if (window.electron?.ipcRenderer) {
              const bounds = await window.electron.ipcRenderer.invoke('get-window-bounds');
              const settings = await this.getStoredSettings();
              settings.windowSize = {
                width: bounds.width,
                height: bounds.height,
              };
              this.saveSettings(settings);
            }
          } catch (error) {
            console.warn('[Desktop Lyrics] Failed to save window size:', error);
          }
        }

        setupWindowResizeListeners() {
          // 监听窗口大小变化
          window.addEventListener('resize', () => {
            // 使用防抖避免频繁保存
            clearTimeout(this.resizeTimeout);
            this.resizeTimeout = setTimeout(() => {
              this.saveCurrentWindowSize();
            }, 500); // 500ms后保存
          });
        }

        setupMutationObserver() {
          const observer = new MutationObserver(() => {
            this.updateWindowHeight();
            // 内容变化时也保存窗口大小（使用防抖）
            clearTimeout(this.contentChangeTimeout);
            this.contentChangeTimeout = setTimeout(() => {
              this.saveCurrentWindowSize();
            }, 1000); // 1秒后保存
          });
          observer.observe(document.body, { childList: true, subtree: true, attributes: true });
          this.updateWindowHeight();
        }
      }

      new LyricsWindow();
    </script>
  </body>
</html>
